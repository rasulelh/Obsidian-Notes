Принципы работы файловых систем (на примере ext4) и структура inode.  

  

---

  

### **Ключевые понятия:**  

1. **Файл** — именованная область данных на диске.  

2. **Создание файла** включает:  

   - Запись данных на диск.  

   - Резервирование места (чтобы блоки не использовались другими файлами).  

   - Присвоение имени.  

  

3. **Хранение файлов:**  

   - Данные хранятся блоками (минимальный размер в ext4 — 4 КБ).  

   - Даже файл размером 1 байт занимает целый блок.  

  

4. **Метаданные:**  

   - Информация о занятых блоках, правах доступа, владельце, времени создания/изменения.  

   - Просмотр: `ls -l` (права, владелец), `ls -li` (номер inode).  

  

5. **Inode:**  

   - Структура данных, хранящая метаинформацию о файле.  

   - Номер inode уникален в рамках файловой системы.  

   - Количество inode фиксировано при создании ФС и не может быть изменено без её пересоздания.  

  

6. **Ограничение ext4:**  

   - Максимальное количество файлов = количество доступных inode.  

   - Проверка: `df -i` (статистика по inode).  

  

---

  

**Важно:**  

- **Inode не хранит имя файла** — это делает файловая система через структуру директорий.  

- Нехватка inode приводит к невозможности создания новых файлов, даже при наличии свободного места на диске.  

  

**Команды для работы:**  

```bash

ls -l    # Просмотр метаданных

ls -li   # Просмотр номеров inode

df -i    # Статистика по inode

```




**Inode** (index node) — это структура данных в файловых системах Unix/Linux, которая хранит **метаданные** о файле (кроме имени и содержимого). Каждый файл и каталог имеет уникальный inode.

---

 **1. Основная информация**
- **Inode содержит:**
  - Тип файла (обычный файл, каталог, символьная ссылка и т. д.).
  - Права доступа (`chmod`).
  - Владельца и группу (`chown`, `chgrp`).
  - Размер файла.
  - Временные метки (создание, изменение, доступ).
  - Указатели на блоки данных (где лежит содержимое).
  - Количество жёстких ссылок (`hard links`).

- **Чего нет в inode?**
  - Имя файла (хранится в каталоге).
  - Содержимое файла (лежит в отдельных блоках).

---

 **2. Как посмотреть inode файла?**
```bash
ls -i file.txt    # Выводит номер inode перед именем
stat file.txt    # Подробная информация (включая inode)
```
**Пример вывода `stat`:**
```
  File: file.txt
  Size: 1024       Blocks: 8          IO Block: 4096   regular file
Device: 801h/2049d  Inode: 1234567    Links: 1
Access: 2024-10-01 12:34:56.789012345 +0300
Modify: 2024-10-01 12:34:56.789012345 +0300
Change: 2024-10-01 12:34:56.789012345 +0300
 Birth: -
```
**Где:**  
- `Inode: 1234567` — номер inode.  
- `Links: 1` — количество жёстких ссылок.  

---

## **3. Зачем нужны inodes?**
- **Поиск файла:**  
  Когда вы открываете `/home/user/file.txt`, система:
  1. Находит inode каталога `/home/user/`.  
  2. Ищет в нём запись `file.txt` → получает номер inode файла.  
  3. По номеру inode получает метаданные и доступ к данным.  

- **Жёсткие ссылки (hard links):**  
  Несколько имён файла ссылаются на **один inode** (это один и тот же файл).  
  ```bash
  ln file.txt hardlink.txt   # Создаёт жёсткую ссылку
  ls -i file.txt hardlink.txt  # Покажет одинаковые inodes
  ```

- **Мягкие ссылки (symlinks):**  
  Символическая ссылка имеет **собственный inode**, который указывает на другой файл.  
  ```bash
  ln -s file.txt symlink.txt  # Создаёт символическую ссылку
  ls -i symlink.txt          # Inode будет отличаться от file.txt
  ```

---

## **4. Проблемы с inodes**
- **Закончились inodes на диске:**  
  Даже если есть свободное место, система не сможет создавать файлы, если исчерпаны inodes.  
  ```bash
  df -i  # Показать использование inodes
  ```
  **Решение:** Удалить ненужные мелкие файлы.

- **Повреждённые inodes:**  
  При сбоях файловой системы inode может "потеряться" (файл есть, но недоступен).  
  **Решение:**  
  ```bash
  fsck /dev/sdX  # Проверка и восстановление ФС
  ```

---

## **5. Интересные факты**
- **Inodes создаются при форматировании диска.**  
  Их количество фиксировано (можно задать при создании ФС, например, в `mkfs.ext4 -N 1000000`).

- **Файлы без имени ("битые" inodes):**  
  Если удалить все жёсткие ссылки на файл, но процесс ещё держит его открытым — данные останутся на диске до закрытия.  

- **Специальные файлы (например, `/dev/sda`) тоже имеют inodes.**  

---

### **Вывод**  
Inode — это "паспорт" файла, связывающий его имя с данными на диске. Понимание inodes помогает разобраться в работе жёстких ссылок, восстановлении файлов и устройстве ФС.